name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  BUILD_TYPE: Release

jobs:
  # Job 1: Build and Test on multiple platforms
  build-and-test:
    name: Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            cc: gcc
            cxx: g++
          - os: macos-latest
            cc: gcc
            cxx: g++
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup build environment
      run: |
        if [ "$RUNNER_OS" == "Linux" ]; then
          sudo apt-get update
          sudo apt-get install -y build-essential
        elif [ "$RUNNER_OS" == "macOS" ]; then
          brew install gcc make
        fi

    - name: Install OpenMP (macOS)
      if: runner.os == 'macOS'
      run: brew install libomp

    - name: Set OpenMP flags (macOS)
      if: runner.os == 'macOS'
      run: |
        echo "LDFLAGS=-L/opt/homebrew/opt/libomp/lib" >> $GITHUB_ENV
        echo "CPPFLAGS=-I/opt/homebrew/opt/libomp/include" >> $GITHUB_ENV
    
    - name: Display compiler versions
      run: |
        ${{ matrix.cc }} --version
        make --version
    
    - name: Build miniAI
      run: |
        make clean
        if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
          make CC=${{ matrix.cc }} CFLAGS="-Wall -Wextra -O3 -march=native -fopenmp" LDFLAGS="-lm -lgomp"
        else
          make CC=${{ matrix.cc }} CFLAGS="-Wall -Wextra -O3 -march=native -Xpreprocessor -fopenmp $CPPFLAGS" LDFLAGS="-lm -lomp $LDFLAGS"
        fi
      env:
        CC: ${{ matrix.cc }}
        LDFLAGS: ${{ env.LDFLAGS }}
        CPPFLAGS: ${{ env.CPPFLAGS }}
    
    - name: Verify executable
      run: |
        ls -lh miniAI
        file miniAI
        ./miniAI help
    
    - name: Run quick training test (static)
      run: |
        timeout 120 ./miniAI train --dataset digits --static || echo "Training test completed or timed out"
      continue-on-error: true
    
    - name: Check model was created
      run: |
        if [ -f "IO/models/digit_brain.bin" ]; then
          echo "OK Model created successfully"
          ls -lh IO/models/digit_brain.bin
        else
          echo "NOT OK Model not created"
          exit 1
        fi
    
    - name: Test model loading
      run: |
        ./miniAI test --model IO/models/digit_brain.bin --dataset digits --static
    
    - name: Run benchmark (quick)
      run: |
        timeout 60 ./miniAI benchmark --dataset digits --static --reps 1 || echo "Benchmark completed or timed out"
      continue-on-error: true
    
    - name: Archive build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: miniAI-${{ matrix.os }}
        path: |
          miniAI
          IO/models/*.bin
          IO/configs/*.txt
        retention-days: 30
    
    - name: Display build info
      run: |
        echo "Build completed successfully!"
        echo "Executable size: $(ls -lh miniAI | awk '{print $5}')"
        echo "Model count: $(ls -1 IO/models/*.bin 2>/dev/null | wc -l)"

  # Job 2: Code Quality Checks
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck clang-format
    
    - name: Run cppcheck
      run: |
        cppcheck --enable=all --suppress=missingIncludeSystem \
          --error-exitcode=0 \
          --inline-suppr \
          src/ headers/ IO/ miniAI.c 2>&1 | tee cppcheck.log
      continue-on-error: true
    
    - name: Check code formatting (clang-format)
      run: |
        find src headers -name "*.c" -o -name "*.h" | while read file; do
          echo "Checking $file"
          clang-format --dry-run --Werror "$file" || true
        done
      continue-on-error: true
    
    - name: Count lines of code
      run: |
        echo "=== Lines of Code ==="
        wc -l miniAI.c src/*/*.c src/*/*/*.c IO/MemoryDatasets.c 2>/dev/null | tail -1
        echo ""
        echo "=== By Category ==="
        echo "Core:" $(wc -l src/core/*.c 2>/dev/null | tail -1 | awk '{print $1}')
        echo "CLI:" $(wc -l src/cli/*.c src/cli/commands/*.c 2>/dev/null | tail -1 | awk '{print $1}')
        echo "Dataset:" $(wc -l src/dataset/*.c 2>/dev/null | tail -1 | awk '{print $1}')
        echo "Image:" $(wc -l src/image/*.c 2>/dev/null | tail -1 | awk '{print $1}')
    
    - name: Upload code quality report
      uses: actions/upload-artifact@v4
      with:
        name: code-quality-report
        path: cppcheck.log
        retention-days: 30

  # Job 3: Documentation Build
  documentation:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check README
      run: |
        if [ -f "README.md" ]; then
          echo "✓ README.md exists"
          wc -l README.md
        else
          echo "✗ README.md missing"
          exit 1
        fi
    
    - name: Validate markdown
      uses: actionshub/markdownlint@main
      continue-on-error: true
    
    - name: Generate project structure
      run: |
        echo "# Project Structure" > STRUCTURE.md
        echo '```' >> STRUCTURE.md
        tree -L 3 -I 'obj|*.bin|*.png' >> STRUCTURE.md || find . -type f -name "*.c" -o -name "*.h" | sort >> STRUCTURE.md
        echo '```' >> STRUCTURE.md
    
    - name: Upload documentation
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: |
          README.md
          STRUCTURE.md
        retention-days: 30

  # Job 4: Security Scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
      continue-on-error: true
    
    - name: Upload Trivy results
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: 'trivy-results.sarif'
      continue-on-error: true

  # Job 5: Performance Benchmark
  benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Build with optimizations
      run: |
        make clean
        make CFLAGS="-Wall -Wextra -O3 -march=native"
    
    - name: Run comprehensive benchmark
      run: |
        echo "=== Digits Benchmark ===" | tee benchmark.log
        timeout 180 ./miniAI benchmark --dataset digits --static --reps 3 | tee -a benchmark.log
        echo "" | tee -a benchmark.log
        echo "=== Alpha Benchmark ===" | tee -a benchmark.log
        timeout 300 ./miniAI benchmark --dataset alpha --static --reps 3 | tee -a benchmark.log
      continue-on-error: true
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: |
          benchmark.log
          IO/configs/*.txt
        retention-days: 90
    
    - name: Comment benchmark results on commit
      if: github.event_name == 'push'
      run: |
        if [ -f "benchmark.log" ]; then
          echo "Benchmark completed. Results uploaded to artifacts."
        fi

  # Job 6: Integration Tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: miniAI-ubuntu-latest
    
    - name: Make executable
      run: chmod +x miniAI
      
    - name: "Test workflow 1: Static digits"
      run: |
        echo "=== Testing Static Digits Workflow ==="
        ./miniAI train --dataset digits --static
        ./miniAI test --model IO/models/digit_brain.bin --dataset digits --static
      
    - name: "Test workflow 2: PNG digits (if images exist)"
      run: |
        if [ -d "IO/images/digitsPNG" ] && [ "$(ls -A IO/images/digitsPNG)" ]; then
          echo "=== Testing PNG Digits Workflow ==="
          ./miniAI train --dataset digits --data
          ./miniAI test --model IO/models/digit_brain_png.bin --dataset digits --data
        else
          echo "PNG digits directory not found or empty, skipping"
        fi
      continue-on-error: true
      
    - name: "Test workflow 3: Static alpha"
      run: |
        echo "=== Testing Static Alpha Workflow ==="
        ./miniAI train --dataset alpha --static
        ./miniAI test --model IO/models/alpha_brain.bin --dataset alpha --static
    
    - name: Verify all models
      run: |
        echo "=== Model Summary ==="
        for model in IO/models/*.bin; do
          if [ -f "$model" ]; then
            echo "OK $model ($(ls -lh "$model" | awk '{print $5}'))"
          fi
        done
    
    - name: Integration test summary
      run: |
        echo "Integration tests completed!"
        echo "Models created: $(ls -1 IO/models/*.bin 2>/dev/null | wc -l)"
        echo "Configs saved: $(ls -1 IO/configs/*.txt 2>/dev/null | wc -l)"

  # Job 7: Summary Report
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality, documentation, integration-tests]
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "# miniAI CI/CD Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Build Status" >> $GITHUB_STEP_SUMMARY
        echo "- **Build & Test**: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Code Quality**: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Documentation**: ${{ needs.documentation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Integration Tests**: ${{ needs.integration-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "- miniAI executables for Ubuntu and macOS" >> $GITHUB_STEP_SUMMARY
        echo "- Trained models and configurations" >> $GITHUB_STEP_SUMMARY
        echo "- Code quality reports" >> $GITHUB_STEP_SUMMARY
        echo "- Documentation" >> $GITHUB_STEP_SUMMARY